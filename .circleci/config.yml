version: 2
jobs:
  build:
    docker:
      # specify the version you desire here
      - image: circleci/openjdk:11.0

      # Specify service dependencies here if necessary
      # CircleCI maintains a library of pre-built images
      # documented at https://circleci.com/docs/2.0/circleci-images/
      # - image: circleci/postgres:9.4

    working_directory: ~/repo

    environment:
      # Customize the JVM maximum heap limit
      MAVEN_OPTS: -Xmx3200m

    steps:
      - checkout

      # Download and cache dependencies
      - restore_cache:
          keys:
            - v1-dependencies-{{ checksum "pom.xml" }}
            # fallback to using the latest cache if no exact match is found
            - v1-dependencies-
      - run: sudo apt-get update
      - run: sudo apt-get install maven
      - run: mvn dependency:go-offline

      - save_cache:
          paths:
            - ~/.m2
          key: v1-dependencies-{{ checksum "pom.xml" }}

      # run tests!
      
      - run: mvn test -Dcucumber.options="src/main/resources/feature/Mobiquity.feature"

description: Installs Allure Framework and registers it as /usr/local/bin/allure
parameters:
  version:
    description: Allure version to use
    type: string
    default: 2.14.0
steps:
  - run:
      name: Allure archive download
      command: >-
        curl -L https://github.com/allure-framework/allure2/releases/download/<<
        parameters.version >>/allure-commandline-<< parameters.version >>.zip -o
        /tmp/allure.zip
  - run:
      name: Archive extraction
      command: unzip /tmp/allure.zip
  - run:
      name: Allure installation
      command: sudo mv allure-<< parameters.version >> /usr/local/share/allure
  - run:
      name: Allure binary symlinking
      command: sudo ln -s /usr/local/share/allure/bin/allure /usr/local/bin/allure
